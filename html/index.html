<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" type='text/css' href='styles.css'/>
<script type="text/javascript" src="jquery.js"></script>
<title>Remote Services</title>
</head>
<body>
	<div class='main'>
		<div class='node'>
			<div class='name'></div>
			<div class='status'></div>
		</div>
		<div id='boxes'>
			SSH to a node with OpenSSH >= 6.7 and socket forwarding
			enabled to see infos here.
		</div>
	</div>

	<script>
		var host;

		function clear() {
			$('#boxes').html("");
		};
		
		function multiMatch(text, severities) {
		  	var matchResult = undefined;
			$.each(['critical','warning'], function(i, name) {
				if(severities[name] === undefined)
					return;
				
				var re = new RegExp(severities[name]);
				var matches = re.exec(text);
				if(matches !== null) {
					//console.log(text+re+" result: "+name);
					matchResult = name;
					return;
				}
			});
			return matchResult;
		}
		
		function markSeverity(s, options) {
				if(options === undefined || options['severity'] === undefined)
					return s;

				switch(multiMatch(s, options.severity)) {
					case 'critical':
					    return "<span class='severity_critical'>"+s+"</span>";
					case 'warning':
					    return "<span class='severity_warning'>"+s+"</span>";					
					default:
						return s;
				}
		}

		function renderString(s, options) {
			var res = new Array();
			$.each(JSON.stringify(s).split(/\\n/), function(i, line) {
				res.push(markSeverity(line.replace(/\"/g, ""), options));
			});
			return res.join('<br/>');
 		}

		function renderTable(s, options) {
			var res = "<table>";
			var re = new RegExp(options.split);
			$.each(s.split(/\n/), function(i, line) {
				res += "<tr>";
				$.each(line.split(re), function(j, column) {
					res += "<td>"+markSeverity(column,options)+"</td>";
				});
				res += "</tr>";
			});
			return res + "</table>";
		}

		function update() {
			$.getJSON("/data/current", {})
			.done(function(d) {
				if(d.name === null)
					d.name = "localhost";

				if(d.name != host) {
					host = d.name;
					clear();
				}
				
				$('.node .name').html(d.name);
				$('.node .status').html('connected');
				$.each(d.data, function(name, d) {
					if(d.d === "")
						return;
					var id = "box_"+name.replace(/ /, "_");
					if(!$('#'+id).length) {
						$('#boxes').append("<div class='box' id='"+id+"'><div class='title'>"+name+"</div><div class='content'/></div>");
					}
										
					var tmp = "Fatal: rendering error!";
					if('render' in d) {
						if(d.render.type === 'table') {
							tmp = renderTable(d.d, d.render);
						} else if(d.render.type === 'lines') {
							tmp = renderString(d.d, d.render);
						} else {
							tmp = "Fatal: unknown renderer type "+d.render.type;
						}
					} else {
						tmp = renderString(d.d);
					}
					$('#'+id+' .content').html(tmp);
				});
			})
			.fail(function(data) {
				console.log("failed to fetch data!");
			});
		}

		(function() {
			update();
			setInterval(function() {
				update();
			}, 2000);
		})();
	</script>
</body>
</html> 
